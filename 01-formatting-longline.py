#!/usr/bin/python3
# -*- coding: utf-8 -*-

import logging

import matplotlib.pyplot as plt

import magnaprobe_toolbox as mt

logger = logging.getLogger(__name__)

# -- USER VARIABLES
# Enable plotting with relative coordinate to the transect origin x0=0, y0=0
plot_origin_flag = True

# Data filename
qc_fp = '/mnt/data/UAF-data/working_a/SALVO/20240416-ARM/magnaprobe/salvo_arm_longline_magnaprobe-geo1_20240416.a2.csv'
# qc_fp = '/mnt/data/UAF-data/working_a/SALVO/20240418-BEO/magnaprobe/salvo_beo_longline_magnaprobe-geo2_20240418.a2.csv'
# qc_fp = '/mnt/data/UAF-data/working_a/SALVO/20240420-BEO/magnaprobe/salvo_beo_longline_magnaprobe-geodel_20240420.a2.csv'
# aqc_fp = '/mnt/data/UAF-data/working_a/SALVO/20240421-ICE/magnaprobe/salvo_ice_library_magnaprobe-geodel_20240421.a2.csv'
qc_data = mt.load.qc_data(qc_fp)

# check direction
if qc_data.iloc[-1]['Longitude'] > qc_data.iloc[0]['Longitude']:
    qc_data = qc_data.iloc[::-1]
qc_data = mt.tools.compute_distance(qc_data)
qc_data = mt.tools.all_check(qc_data)

# Since the longline transect is measured without a fixed distance, we don't check for distance (flag = 8)
qc_data.loc[qc_data['Quality'] == 8, 'Quality'] = 0
if len(qc_data[qc_data['Quality'] > 6]) > 0:
    print('Cleaning is still needed')



# Generate output_filename
output_fp = mt.io.output_filename(qc_fp)
fig_fp = output_fp.split('.')[0] + '.pdf'

mt.export.data(qc_data, output_fp)

# Plot basic figures:
site = output_fp.split('_')[2].upper()
date = output_fp.split('.')[0][-8:]
if '_longline' in output_fp:
    name = 'Long transect'
elif '_line' in output_fp:
    name = '200 m transect'
elif 'library' in output_fp:
    name = 'Library site'

fig_title = ' - '.join([site.upper(), name, date])

# Data status plot
plot_df = qc_data.set_index('TrackDistCum', drop=True)
input_df = plot_df
# Move origin points to x0, y0
if plot_origin_flag:
    plot_df['x0'] = plot_df['X'] - plot_df.iloc[0]['X']
    plot_df['y0'] = plot_df['Y'] - plot_df.iloc[0]['Y']
else:
    plot_df['x0'] = plot_df['X']
    plot_df['y0'] = plot_df['Y']

plt.style.use('ggplot')

# Define figure subplots
fig = mt.io.plot.summary(plot_df, library=False )
fig.suptitle((' - '.join([site.upper(), name, date])))

plt.savefig(fig_fp)
plt.show()